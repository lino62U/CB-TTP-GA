<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de API de Disponibilidad</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            margin: 10px 0;
        }
        .grid-cell {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            font-size: 12px;
        }
        .grid-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .selected {
            background-color: #28a745;
            color: white;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>üß™ Prueba de API de Disponibilidad de Profesores</h1>
    
    <div class="container">
        <!-- Panel de Login -->
        <div class="section">
            <h3>üîê Login</h3>
            <div class="login-form">
                <input type="email" id="email" placeholder="Email" value="carlos@unsa.edu.pe">
                <input type="password" id="password" placeholder="Contrase√±a" value="123456">
                <button onclick="login()">Iniciar Sesi√≥n</button>
            </div>
            <div class="output" id="loginOutput"></div>
        </div>

        <!-- Panel de Control -->
        <div class="section">
            <h3>‚ö° Acciones R√°pidas</h3>
            <button onclick="getTimeSlots()">Obtener Time Slots</button>
            <button onclick="getProfessorInfo()">Info del Profesor</button>
            <button onclick="getAvailability()">Ver Disponibilidad</button>
            <button onclick="saveAvailability()">Guardar Disponibilidad</button>
            <div class="output" id="actionOutput"></div>
        </div>
    </div>

    <!-- Panel de Disponibilidad -->
    <div class="section">
        <h3>üìÖ Grid de Disponibilidad</h3>
        <div id="availabilityGrid"></div>
    </div>

    <!-- Panel de Log -->
    <div class="section">
        <h3>üìù Log de Actividad</h3>
        <button onclick="clearLog()">Limpiar Log</button>
        <div class="output" id="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        let token = '';
        let currentProfessorId = null;
        let timeSlots = [];
        let selectedTimeSlots = new Set();

        function log(message) {
            const logEl = document.getElementById('log');
            logEl.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                document.getElementById('loginOutput').textContent = JSON.stringify(data, null, 2);
                
                if (data.token) {
                    token = data.token;
                    currentProfessorId = data.user.id;
                    log(`Login exitoso para: ${data.user.name}`);
                } else {
                    log('Error en login: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                log('Error de conexi√≥n: ' + error.message);
            }
        }

        async function getTimeSlots() {
            try {
                const response = await fetch(`${API_BASE}/professors/time-slots`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                const data = await response.json();
                timeSlots = data;
                document.getElementById('actionOutput').textContent = JSON.stringify(data, null, 2);
                log(`Obtenidos ${data.length} time slots`);
                renderGrid();
            } catch (error) {
                log('Error obteniendo time slots: ' + error.message);
            }
        }

        async function getProfessorInfo() {
            if (!currentProfessorId) {
                log('Debe iniciar sesi√≥n primero');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/professors/${currentProfessorId}`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                const data = await response.json();
                document.getElementById('actionOutput').textContent = JSON.stringify(data, null, 2);
                log('Informaci√≥n del profesor obtenida');
            } catch (error) {
                log('Error obteniendo info del profesor: ' + error.message);
            }
        }

        async function getAvailability() {
            if (!currentProfessorId) {
                log('Debe iniciar sesi√≥n primero');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/professors/${currentProfessorId}/availability`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    credentials: 'include'
                });
                
                const data = await response.json();
                document.getElementById('actionOutput').textContent = JSON.stringify(data, null, 2);
                
                // Actualizar selecci√≥n en el grid
                selectedTimeSlots.clear();
                if (data.availability) {
                    data.availability.forEach(avail => {
                        selectedTimeSlots.add(avail.time_slot.id);
                    });
                }
                renderGrid();
                log(`Disponibilidad cargada: ${data.availability?.length || 0} slots`);
            } catch (error) {
                log('Error obteniendo disponibilidad: ' + error.message);
            }
        }

        async function saveAvailability() {
            if (!currentProfessorId) {
                log('Debe iniciar sesi√≥n primero');
                return;
            }
            
            try {
                const timeSlotIds = Array.from(selectedTimeSlots);
                const response = await fetch(`${API_BASE}/professors/${currentProfessorId}/availability`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ time_slot_ids: timeSlotIds }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                document.getElementById('actionOutput').textContent = JSON.stringify(data, null, 2);
                log(`Disponibilidad guardada: ${timeSlotIds.length} slots`);
            } catch (error) {
                log('Error guardando disponibilidad: ' + error.message);
            }
        }

        function renderGrid() {
            const grid = document.getElementById('availabilityGrid');
            if (timeSlots.length === 0) {
                grid.innerHTML = '<p>Primero obtenga los time slots</p>';
                return;
            }

            const days = ['LUN', 'MAR', 'MIE', 'JUE', 'VIE'];
            const timeBlocks = [
                "07:00-07:50", "07:50-08:40", "08:50-09:40", "09:40-10:30", "10:40-11:30", "11:30-12:20",
                "14:00-14:50", "14:50-15:40", "15:50-16:40", "16:40-17:30", "17:40-18:30", "18:30-19:20", "19:20-20:10"
            ];

            let html = '<div class="grid">';
            
            // Headers
            html += '<div class="grid-cell grid-header">Horario</div>';
            days.forEach(day => {
                html += `<div class="grid-cell grid-header">${day}</div>`;
            });
            
            // Rows
            timeBlocks.forEach(timeBlock => {
                html += `<div class="grid-cell">${timeBlock}</div>`;
                days.forEach(day => {
                    const slot = timeSlots.find(ts => 
                        ts.day_of_week === day && 
                        ts.start_time.substring(0, 5) === timeBlock.split('-')[0] &&
                        ts.end_time.substring(0, 5) === timeBlock.split('-')[1]
                    );
                    
                    const isSelected = slot && selectedTimeSlots.has(slot.id);
                    const className = `grid-cell ${isSelected ? 'selected' : ''}`;
                    
                    if (slot) {
                        html += `<div class="${className}" onclick="toggleSlot(${slot.id})" style="cursor: pointer;">${isSelected ? '‚úì' : ''}</div>`;
                    } else {
                        html += '<div class="grid-cell" style="background-color: #ddd;"></div>';
                    }
                });
            });
            
            html += '</div>';
            grid.innerHTML = html;
        }

        function toggleSlot(slotId) {
            if (selectedTimeSlots.has(slotId)) {
                selectedTimeSlots.delete(slotId);
            } else {
                selectedTimeSlots.add(slotId);
            }
            renderGrid();
            log(`Slot ${slotId} ${selectedTimeSlots.has(slotId) ? 'seleccionado' : 'deseleccionado'}`);
        }

        // Inicializar
        log('Sistema de prueba iniciado');
    </script>
</body>
</html>
